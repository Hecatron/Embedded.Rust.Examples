[env]
# Show debugging info on error of build
RUST_BACKTRACE = 1

# Set custom paths for rustc for the esp32
XARGO_RUST_SRC = "D:\\SourceCode\\External\\rust-xtensa\\library"
RUSTC = "D:\\SourceCode\\External\\rust-xtensa\\build\\x86_64-pc-windows-msvc\\stage2\\bin\\rustc"
RUSTDOC = "D:\\SourceCode\\External\\rust-xtensa\\build\\x86_64-pc-windows-msvc\\stage2\\bin\\rustdoc"

# Serial port for flashing
ESP32_FLASH_SERIAL = "COM4"

[tasks.install-rust-src]
description = "install rust-src via rustup component add"
install_crate = { rustup_component_name = "rust-src" }

[tasks.format]
description = "reformat the rust code using rustfmt"
install_crate = "rustfmt"
command = "cargo"
args = ["fmt", "--", "--emit=files"]

[tasks.build]
description = "build the source in debug mode - ESP32"
command = "cargo"
dependencies = [ "install-rust-src" ]
args = ["xbuild", "${@}"]
category = "ESP32-Build"

[tasks.build-release]
description = "build the source in release mode - ESP32"
command = "cargo"
dependencies = [ "install-rust-src" ]
args = ["xbuild", "--release", "${@}"]
category = "ESP32-Build"

[tasks.flash-build]
description = "build the source in debug mode and upload to the flash - ESP32"
command = "cargo"
dependencies = [ "install-rust-src" ]
args = ["espflash", "--chip=esp32", "--tool=\"xbuild\"", "${ESP32_FLASH_SERIAL}", "${@}"]
category = "ESP32-Build"

[tasks.flash-build-release]
description = "build the source in release mode and upload to the flash - ESP32"
command = "cargo"
dependencies = [ "install-rust-src" ]
args = ["espflash", "--chip=esp32", "--tool=\"xbuild\"", "--release", "${ESP32_FLASH_SERIAL}", "${@}"]
category = "ESP32-Build"

[tasks.esp32-flashid]
description = "Get the flashid / details from the esp32"
command = "esptool"
dependencies = [ "install-rust-src" ]
args = ["--chip", "esp32", "-p", "${ESP32_FLASH_SERIAL}", "flash_id", "${@}"]
category = "ESP32-Flash"

[tasks.esp32-eraseflash]
description = "Erase the flash on the ESP32"
command = "esptool"
dependencies = [ "install-rust-src" ]
args = ["--chip", "esp32", "-p", "${ESP32_FLASH_SERIAL}", "erase_flash", "${@}"]
category = "ESP32-Flash"
